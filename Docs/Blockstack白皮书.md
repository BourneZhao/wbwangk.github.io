# Blockstack 技术白皮书

Muneeb Ali Ryan Shea Jude Nelson Michael J. Freedman Blockstack：分散式应用程序的新互联网[https://blockstack.org](https://blockstack.org/) 
技术白皮书1.1版2017年10月12日
版权所有2017 Blockstack PBC - a Public Benefit Corp.保留所有权利。

本白皮书的部分内容早在以下同行评议的会议和杂志中发表：

•M. Ali，J. Nelson，R. Shea和MJ Freedman，“Blockstack：由区块链保护的全球命名和存储系统”，2016年USENIX年度技术会议，丹佛，CO，2016年6月。

•J. Nelson，M. Ali，R. Shea和MJ Freedman，“用虚拟链扩展现有区块链”，分布式加密货币和共识分类标准研讨会，芝加哥，IL，2016年7月。

•M. Ali，J. Nelson，R. Shea和MJ Freedman，“使用区块链在分布式系统中引导信任”，USENIX;登录：问题：Vol。2016年秋季第41页，第3号，第52-58页。

免责声明：Blockstack Tokens是加密资产，目前正由特拉华州有限责任公司Blockstack Token LLC开发，其网站可在[www.blockstack.com](http://www.blockstack.com/) 上找到。本白皮书不构成Blockstack令牌（令牌）或任何其他机制的报价或出售

用于购买令牌（例如但不限于持有令牌的基金或与令牌有关的未来令牌的简单协议）。令牌或任何相关工具的任何报价或出售仅基于令牌或适用工具的最终报价文件进行。

Blockstack：分散式应用的新互联网

Muneeb Ali * Ryan Shea * Jude Nelson Michael J. Freedman†

[http://blockstack.org](http://blockstack.org/)

白皮书1.1版

2017年10月12日

抽象

传统的互联网有许多失败和信任的中心点，例如（a）域名系统（DNS）服务器，（b）公钥基础设施，以及（c）存储在集中数据存储上的最终用户数据。我们介绍一种名为Blockstack的新互联网的设计和实现，用户不需要信任远程服务器。我们从网络中间删除任何信任点，并使用区块链来保护关键数据绑定。Blockstack实现了身份识别、发现和存储服务，并且可以承受潜在区块链的故障。基于大型区块链生产系统的三年经验得出了Blockstack的设计。Blockstack具有与传统互联网服务相媲美的性能，能够为传统互联网提供急需的安全性和可靠性升级。

## 1介绍

互联网是在40多年前设计的，并且正在显示老迈的迹象。重要的互联网服务可能通过诸如DNS服务器上的DDoS攻击之类的攻击导致脱机[1]。而且，在当前的互联网体系结构中，用户隐式地信任某些隐藏的服务和中介，例如域名服务器和认证机构（CA）。这些信任点可以被利用来欺骗用户连接到恶意网站，例如土耳其CA为Google发布虚假安全证书的最近事件[2]。在过去的十年中，我们看到了从桌面应用程序（本地运行）转向基于云的应用，这些应用程序将用户数据存储在远程服务器上。这些集中式服务是黑客的主要目标，并经常遭到黑客攻击。在2016年，Yahoo！承认失去了5亿人的信息[3]。

核心互联网基础架构的安全问题和基于顶级Web服务的集中式数据模型在互联网的原始设计中暴露出缺陷。

Blockstack是重新分散互联网的开源项目; 它为分布式应用建立了一个新的互联网，使用户能够直接拥有他们的应用数据[4]。Blockstack使用现有的互联网传输层（TCP或UDP）和底层通信协议，并着重于删除应用层中存在的集中点。替代传输层协议，如新的mesh网络协议[5]，可以用Blockstack来支持。

创建完全分散的核心互联网组件（如DNS、公钥基础结构和存储后端）的替代品有许多基础技术难题。新用户/节点需要在网络上建立信任并发现相关数据，而不依赖任何远程服务器。分散式解决方案需要提供与传统互联网相媲美的性能，并相应地进行扩展。我们的Blockstack的实现有三个组件：

1. 一个使用虚拟链[6]实现的区块链，用于将数字资产（如域名）绑定到公钥上。Blockstack的区块链解决了以分散方式建立信任的问题，即网络上的新节点可以独立验证所有数据绑定。
2. 称为Atlas的对等网络为查找信息提供全局索引
3. 称为Gaia的分散存储系统提供高性能存储后端，无需引入中央信任方。Blockstack被部署在生产环境中，到目前为止，已有多个公司和开源贡献者使用Blockstack [4]积极开发新服务，已注册了74,000个新域名。我们已经发布了Blockstack作为开源[7]项目。

## 2 系统架构

Blockstack具有以下设计目标：

1. **分散的命名和发现**：最终用户应该能够（a）注册和使用人类可读的名称，并（b）发现映射到人类可读名称的网络资源，而不信任任何远程方。
2. **分散存储**：最终用户应该能够使用分散存储系统，以便他们可以存储他们的数据而不会将其泄露给任何远程方。
3. **可比较的性能**：新架构的端到端性能（包括名称/资源查找、存储访问等）应与具有集中式服务的传统互联网相媲美。直到最近，分布式命名系统被认为是不可能建立的（参见Zooko在第3节中的三角形），分布式存储系统如BitTorrent等不提供与集中式服务相媲美的性能/带宽[8]。Blockstack提出了解决这些问题的方法。

**设计决定＃1：解决基础区块链的失败**

我们的架构不会限制哪些区块链可以与它一起使用。任何区块链都可以使用，只要它提供**操作的总排序**（所有区块链都这样做），但是安全性和可靠性属性直接依赖于底层区块链。我们认为，提供从一个区块链迁移到另一个区块链的能力非常重要，因为它允许更大的系统生存，即使潜在的区块链受到损害。我们的架构还允许多个底层区块链，并将区块链视为交付渠道，以提供完全有序的操作; 只要他们能够单独提供完全有序的操作，任何数量的基础通信通道都可以工作。

**设计决定2：保持区块链以外的复杂性和逻辑性**

像Namecoin [9]以太坊 [10]这样的许多区块链在区块链层面实现了控制逻辑和数据存储（尽管他们将来可能会使用外部数据存储）。我们认为，不使用区块链进行数据存储对于可伸缩性是必要的，并且保持区块链之外的复杂逻辑对于安全性和可伸缩性都很重要。不需要网络上的节点来计算复杂的不受信任的程序，只是为了保持与网络的同步。此外，在部署并获得真实世界的使用后，很难将新功能引入区块链。我们介绍虚拟链的概念（第4节），它可以在区块链之上构建任意状态机，而不需要对底层区块链进行任何修改。基础区块链之上的操作总排序的抽象。充当我们架构的“窄腰”，并且保持复杂性在区块链以外。

**设计决定3：全局数据的可伸缩索引**

任何分散的网络都需要索引它所存储的数据。回到对等网络的早期，Napster在1999年推出了一种集中式索引，并且分散式文件传输。开始时BitTorrent也使用集中跟踪器（索引），后来又引入了基于DHT的分散式索引。基于DHT的对等网络容易受到Sybil攻击，并且历史上一直不可靠并且难以扩展，特别是在大量扰动的情况下。我们首先遇到了这些问题，因为我们最初的Blockstack同行网络是基于Kademlia DHT。我们引入了一种新的非结构化对等网络，称为Atlas网络，它解决了使用对等网络的分散存储的特殊情况 - 这种情况下（a）数据集规模小，（b）用一个全局列表列出了所有对于网络可用的索引项目。在Atlas中，节点保持100％状态副本。非结构化方法更容易实现，没有维护路由结构的开销，并且能抵御有针对性的节点攻击（每个节点都有完整的数据副本）。

（图）

图1：Blockstack体系结构概述。

### 2.1 Blockstack层

Blockstack的体系结构有三层，如图1所示，控制平面中有一层（区块链层），数据平面中有两层（对等网络和数据存储）。控制平面处理较小的数据量，主要涉及引导信任[11]以及定义人类可读名称和网络资源之间的映射。数据平面包含有关如何发现数据（路由/指向数据的指针）和实际存储后端的信息。数据被广泛复制，并且从什么源客户端读取数据并不重要; 客户可以独立地从控制平面验证他们是否接收到正确的数据。

#### 第1层：区块链

在我们的架构中，区块链占据最低层，并且有两个目的：它为操作提供存储介质，并提供操作写入顺序的共识。虚拟链在底层区块链中对交易进行编码。区块链提供了对虚拟链的完全有序操作的抽象，并充当我们建筑的“窄腰”。像挖矿操作、共识算法、加密货币波动等很多复杂性都隐藏在这个抽象的下面。较高层只关心读/写完全有序的操作，并且可以在任何区块链上运行。

区块链层还包含一个虚拟链，它定义了新的操作，而无需更改底层区块链。底层区块链的节点不知道这一层。虚拟链就像虚拟机，其中像Debian 8.7这样的特定虚拟机可以在特定的物理机器上运行。可以定义不同类型的虚拟链，并在特定的底层区块链之上运行。虚拟链操作在有效的区块链交易中被编码为额外的元数据。区块链节点确实看到原始交易，但处理虚拟链操作的逻辑仅存在于虚拟链级别。虚拟链操作在有效的区块链交易中被编码为额外的元数据。区块链节点确实可以看到原始交易，但处理虚拟链操作的逻辑仅存在于虚拟链级别。

接受或拒绝虚拟链操作的规则定义在特定的虚拟链中，例如虚拟链为了实现全局命名系统的操作定义了一个单一状态机。通过我们的虚拟链中定义的规则接受的操作将被处理，以构建一个数据库，该数据库存储命名系统的全局状态信息以及任何给定区块链中的状态更改。

#### 第2层：对等网络

Blockstack使用对等网络进行发现。对等网络是数据平面的一部分。我们的架构将实际存储数据的资源发现（即数据路由）分离出来。这避免了系统需要从一开始就采用任何特定的存储服务，而是允许多个存储提供商共存，包括云存储和P2P系统。

Blockstack实现使用区域文件来存储路由信息，这些路由信息与其格式中的DNS区域文件相同。区域文件存储在发现层中，由Blockstack作为对等网络实现。用户不需要信任发现层，因为发现层中任何数据记录的完整性都可以通过检查控制层中该数据记录的相应哈希来验证。

在Blockstack当前的实现中，节点形成一个对等网络，称为Atlas网络（第5节），用于存储区域文件。对等网络只允许区域文件被写入，如果散列（区域文件）先前在区块链中被宣布。这有效地将可存储在对等网络中的数据列入白名单。表示路由的数据记录（不论它们从何处取得）都可以被验证，因此不能被篡改。在Atlas网络的当前实现中，对等节点保留所有区域文件的完整副本，因为区域文件的大小相对较小（每个文件4KB）。保存所有路由数据的完整副本只会在存储区块链数据（大约几个GB）的基础上引入边际存储成本。

#### 第3层：存储

最顶层（第3层）是存储层，它承载实际数据值并且是数据平面的一部分。所有存储的数据值都由控制平面中定义的所有者密钥进行签名。通过在区块链之外存储数据值，Blockstack允许任意大小的值并允许各种存储后端。用户不需要信任存储层，并可以在控制平面中验证其完整性。我们的设计受益于所使用的后端云存储系统的性能和可靠性，并提供与传统互联网服务相媲美的性能。

Blockstack通过在新的虚拟链中定义操作并将发现数据存储在名为Atlas Network的对等网络（第5节）中，实现了一个分散的命名系统，称为区块链名称系统（BNS）。我们的虚拟链使用底层区块链就BNS的状态达成一致并将名称与数据记录绑定。依靠底层区块链的共识协议，我们的虚拟链可以为BNS支持的所有操作提供全面的排序，如名称注册、名称更新和名称传输。我们的虚拟链表示BNS的全局状态，包括谁拥有特定的名称以及哪些数据与名称关联。在接下来的章节中我们会详细介绍这些组件。

## 3 BNS：区块链名称系统

传统的互联网使用域名系统（DNS）将人类可读名称映射到IP地址（其给出节点和内容的位置）。当互联网用户在他们的浏览器中输入cnn.com时，DNS服务器会返回人类可读名称到IP地址的映射。ICANN是一个非营利组织，负责管理DNS和根服务器。这些服务器是信任和失败的中心点; 他们可以通过DDoS攻击至离线，域名的映射可以通过强制更改DNS服务器或通过欺骗来自他们的回复来更改。

在Blockstack中，我们需要一个分散的DNS替代品，即一个将人类可读名称绑定到发现数据但没有任何中心失败或控制点的系统。有一种思想流派认为，人类可读的名称并不重要，长时间的加密ID与搜索引擎结合可以代替DNS [12,13,14]。我们认为，人类可读的名字对于提供良好的用户体验至关重要，并且在实践中，要说服互联网用户改变他们的习惯并停止在网上使用人类可读的名字是非常困难的。

建立命名系统有一个基本的计算机科学挑战。名称有三个属性：名称是（1）唯一的（意味着没有两个人可以独立创建和使用像cnn.com这样的唯一名称的情况），（2）人类可读的（a名称应该看起来像保罗而不是1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa），和（3）分散（名称应该由网络边缘的用户选择，而不是由中心的中央机构代表用户）。计算机科学的挑战在于，在区块链之前，命名系统只允许这三种属性中的任意两种[15]，而不是同时存在三种。这个限制被称为Zooko的三角[16]。例如，公钥是独一无二且分散的，因为用户可以在他们的计算机上生成它们而无需与任何中央服务通话，但是不可读。Twitter句柄是人类可读且唯一的，但不是分散的（Twitter，该公司控制着名称空间）。昵称是人类可读和分散的（用户可以为任何人选择任何昵称），但不是唯一的。区块链实现了Zooko的三角形，第一次有可能在没有使用集中服务的情况下拥有唯一性的人类可读名称[16]。

Namecoin [9]是第一个使用区块链构建分散化命名系统的系统。我们在Namecoin上运行生产网络的经验揭示了某些安全性和可靠性问题，突出了使用最大的最安全的区块链网络的必要性[17]。

### 3.1 BNS业务
（后面的谷歌翻译没有人工校正---wbwangk）
我们提出了一种名为区块链名称系统（BNS）的基于区块链的新命名系统的设计。我们对BNS的实施已经运行了3年多。在我们的新互联网中，BNS是DNS的替代品，旨在提供类似的功能，但没有任何中央根服务器。在BNS中，名称由底层区块链的密码地址及其相关私钥（例如，比特币中使用的基于ECDSA的私钥）所拥有[18]）。用户预先安排并在两阶段提交过程中注册一个名称。这样做是为了避免攻击者可以在注册名称时竞争用户的前台运行，因为攻击者将能够在网络上看到未经确认的交易。成功编写预订和注册交易的第一个用户被授予该名称的所有权。此外，任何先前的预订都会在注册名称时失效。一旦名称被注册，用户可以通过发送更新交易并上传名称 - 值绑定来更新名称 - 值对。名称传输操作只是更改允许签署后续交易的地址，而撤销操作则禁用任何名称的进一步操作。

在BNS中，名称被组织到命名空间中，这些命名空间与DNS中顶级域名的功能相当 - 它们定义了名称的成本和更新率。与名称一样，名称空间必须预先排序并注册。如图2所示，在BNS中，顶级域名（名称空间）的信息已注册在根区块链中。顶级域名（TLD）的条目可以指向存储该顶级域名（TLD）上注册域的数据的其他区块链。根区块链也可用于定义TLD，在这种情况下，TLD条目指向相同的区块链。在DNS中，DNS根服务器，TLD服务器和授权服务器位于最终用户的信任区域之外，其中信任区域被定义为本地机器或本地网络，并且可以包括受节点控制（并受信任）的节点广域的最终用户。图2（顶部）显示了princeton.edu的递归DNS查询。该查询在用户的信任区域之外解决。在BNS中，本地BNS服务器从各自的（分散的）区块链网络获取区块链数据，并保持与区块链网络不断同步的本地副本。个别区块链记录很小，包含指向区块链外数据的指针，例如在对等网络中。要解析一个名称，比如werner.id，最终用户向在其信任区内运行的本地BNS服务器发出查询。本地BNS服务器查看相应的区块链记录并从外部源（如对等网络）获取相应的区域文件。区域文件的外部来源不受信任。区域文件的散列存在于区块链记录中，并且任何篡改尝试都可以轻松检测到（通过检查散列）。图3显示了单个域的示例BNS区域文件。

图2：递归DNS查询（顶部）和迭代BNS查询。

示例区域文件：

图3：BNS的示例区域文件。

定价功能：任何人都可以在名称空间中创建名称空间或注册名称，因为没有中央方阻止某人这样做。定价函数定义了创建名称空间或在名称空间中注册名称的成本。定义智能定价功能是防止“抢占土地”的一种方法，即阻止人们注册许多他们不打算实际使用的名称空间/名称。BNS支持复杂的定价功能。例如，我们在我们的BNS实现中使用定价函数创建了一个.id名称空间，其中（a）名称价格随着名称长度的增加而下降，（b）在名称中引入非字母字符也会降低价格。有了这个定价函数，john.id> johnadam.id> john0001.id的价格。该功能通常受到以下观察结果的启发：只有带有字母符号的短名称才被认为更适合名称空间，如Twitter用户名。有可能创建名称空间，其中名称注册也是免费的。此外，我们预计未来将会有名称的代理商市场，就像DNS一样。关于定价功能的详细讨论超出了本白皮书的范围，读者可以参考[15]了解定价函数和分散命名系统中的名字蹲问题的更多细节。Blockstack使用BNS作为默认的命名系统。BNS通过在新虚拟链中定义状态机和状态转换规则来实现。我们将区域文件存储在称为Atlas Network的新对等网络中。我们分别在第4部分和第5部分给出了我们的BNS实现的细节，其中包含虚拟链和Atlas。与名称一样，名称空间也具有定价功能[7]。为了启动Blockstack上的第一个命名空间，.id命名空间，我们向网络支付了40个比特币（当时为10,000美元）。这表明即使是这个分散系统的开发者也必须遵守规则并支付适当的费用。

3.2 BNS中的公钥

在传统的互联网DNS域可以使用数字证书来增强安全性。网站的数字证书是互联网安全的基石。当用户看到“绿色锁定标志”时，他们觉得他们处于安全连接状态。在后台，他们的浏览器检查网站的数字证书。“绿色锁定标志”表示某些认证中心（CA）（如Verisign）向网站发布了数字证书，并且该网站拥有该证书的所有权。证书颁发机构可以颁发“恶意”证书，在未经他们许可的情况下冒充企业和网站，用户最终会信任恶意证书 - 近期历史上发生过几次真正的问题，例如Turktrust（一家土耳其CA）发布了恶意证书为Google。

区块链可用作公钥和数字证书的全球分布机制。由于区块链提供了全局视图，并且非常难以篡改，因此攻击者在发布证书之后更改证书或仅向部分用户呈现不正确的信息是不切实际的。而且，在基于区块链的PKI中，没有可以被攻击的中央CA来攻击系统。

BNS已经提供了与域名和所有域的公共密钥关联，默认情况下，获得证书。虽然像Lets Encrypt [19]这样的努力正在降低获得数字证书的成本，并鼓励更多的网站启用安全连接，但绝大多数互联网仍然运行在不安全的连接上。如果命名系统默认绑定公钥，则所有网站都有安全证书，并且默认情况下安全性处于打开状态。在BNS中，域名可以作为公钥的令人难忘的标识符。这些名称本身对身份没有影响，只能用作令人难忘的标识符。第三方认证可以在以后被附加到难忘的名字上。此外，所有BNS节点都可以访问单个全局状态，因此任何用户都无法隐藏公钥映射的任何密钥撤销或状态更改。

4虚拟链

公共区块链正在成为一种通用的网络服务。但是，很难对生产区块链网络进行破坏性更改。直接在区块链中引入新功能需要网络中的每个人（包括矿工）进行升级。这些升级可能会破坏共识并引发分歧[18]。我们使用Namecoin区块链的经验表明，启动新的较小的区块链会导致安全问题，例如攻击网络所需的计算能力降低，应尽可能避免[17]。为了克服这个问题，我们创建了虚拟链，这是一个用于在已经运行的区块链上创建任意状态机的虚拟区块链。与虚拟机一样，虚拟链可以将（从一个区块链转移到另一个区块链）并提高容错能力。我们之前使用虚拟链将生产网络从Namecoin迁移到Bitcoin [20]。迁移表明，虚拟链可以用来应对底层区块链的失败。

区块链提供了一个完全有序的，防篡改的状态转换日志。新的应用程序可以将所有状态更改的日志存储在公共区块链中，例如比特币[21]，莱特币[22]或以太坊[10]。通过将区块链用作共享通信通道，这些应用程序可以以安全，分散的方式引导全局状态，因为网络上的每个节点都可以独立构建相同的状态。

但是，使用区块链作为分散式应用程序和服务的构建块有两个关键挑战：

1. 首先，区块链可能会失败，即它可以脱机，或者它的共识机制可以通过属于单一实体的事实控制而变得“集中”。为了容忍这种失败，应该可以有效地跨区块链迁移应用程序状态。
2. 第二个挑战是如果底层区块链分叉，应用程序的日志可能会分叉并损坏。在区块链分叉下，不同货叉上的节点将写入和读取不同的事件。当叉解析时，区块链可能会丢弃和重新排序交易，导致引导节点构建与已经运行的节点不同的状态。应用程序必须能够从区块链分叉中恢复。

4.1虚拟链的设计

虚拟链是一个虚拟区块链（一个逻辑层），用于在区块链之上构建多个状态机。虚拟链处理底层区块链中的交易以在区块链上构建状态机。虚拟链提供了分叉*一致性模型[23]。应用程序节点重放它们的日志以在每个块b处实现应用级别一致性，使得当且仅当该块中的应用程序交易使节点处于相同状态时，两个节点将同意块。如果在执行块b中的操作后它们的结果状态是相同的，那么它们为该块生成的一致性散列将是相同的。共识哈希使节点能够独立审计并高效查询历史记录，并检测叉并在区块链之间迁移状态。

图4显示了虚拟链只处理来自底层区块链的相关交易（具有有效虚拟链操作码的交易）并忽略其他交易。虚拟链接受的交易被组织在虚拟块中，虚拟块通过每个块的共同散列链接在一起; 块中的一致性散列反映了以前的所有虚拟链历史。Blockstack的虚拟链实现BNS状态机。我们的虚拟链目前使用比特币作为底层区块链。新的操作码在比特币交易中通过指定用于附加数据的字段进行公布，称为OP RETURN。这是今天比特币区块链上OP RETURN交易的最大用例之一[24]。

一致性模型：大多数公共区块链使用Nakamoto共识的变体[18]，它允许并行的领导者。附加冲突块会创建区块链分叉，这些区域使用工作量证明[25]指标进行解析。具有最多工作证明的分岔中的交易被认为是权威性的; 冲突的交易被无声地丢弃，而非冲突的交易被合并到后续的块中。

Nakamoto的共识给出了区块链的性质，即如果没有持久的网络分区，并且大多数计算能力是由诚实的同伴控制的话，长叉指数更少。这意味着在大多数情况下，交易很可能在持续数量的块（确认）被附加在它们顶部之后持久且可线性化。我们使用这些属性在公共区块链之上实现fork * - 一致的复制状态机（RSM）。应用程序节点读取区块链来构造状态机副本并将新交易提交到区块链以执行状态转换。

共识哈希：为了取得进展，节点读取新的区块链交易并确定每个底层区块链交易是否代表虚拟链中的有效状态转换。由于任何人都可以编写交易并且可以任意延迟，所以节点必须能够过滤交易（和相关的状态转换）并忽略与他们不感兴趣的分支有关的交易。我们通过要求当前的共识散列在新交易中宣布。

共识散列是每个节点在每个块计算的加密散列。它来源于最后处理块中接受的状态转换，以及先前计算出的几何一致性哈希的几何系列。图5显示了这个过程。假设tx∈bn是块bn中发现的交易日志序列，令Merkle（tx∈bn）为计算这些交易上的Merkle树根的函数，并让Hash（x）为加密散列函数。然后，我们将CH（n）定义为块n处的共识散列，其中

Vn = Merkle（tx∈bn）（1）

CH（n）=散列（Vn + Pn）（2）

块b0包含第一个日志条目，而Pn是从b开始的先验共识散列的几何序列，即前一个块的共识散列，两个块前，四个块前等。

用户在通过客户端提交的每个交易中都包含最新的已知CH（n），而应用程序会忽略“过时”（太旧）或未知共识哈希的状态转换。这样，应用程序就会忽略自己的日志分支，应用程序用户（或他们正在使用的客户端）可以知道何时重试丢失的交易（通知状态转换）。在这样做的时候，一致性哈希值保留了fork的最多加入属性* -consistency：只有当它接受到所有先前导出CH（n）的状态转换时，应用程序才会接受CH（n）的状态转换）。

快速查询：并非所有用户都会在其计算机上拥有完整区块链的副本。我们使用协议进行快速查询，这对于创建不需要区块链或状态副本的“轻量级节点”非常有用。相反，他们可以根据需要查询高可用性但不可信的“完整节点”（具有区块链的完整副本）。例如，Blockstack的虚拟链使用此功能来实现简单名称验证（SNV）协议[26]。

对于快速查询，应用程序用户从可信节点（例如在同一主机上运行的节点）获得CH（n）。然后用户可以使用这个可信CH（n）在对数的时间和空间中查询来自不可信节点的先前状态转换。为此，它使用CH（n）迭代查询和验证Pn和Merkle（tx∈bn），直到找到CH（n 0）和Merkle（tx∈b 0 n），其中b 0是包含状态转换到查询。一旦它有Merkle（tx∈b 0 n），它可以请求并验证以前的状态转换（tx∈b 0 n）。

区块链叉检测和恢复：如果交易日志从不追溯fork，应用程序逻辑和共识哈希可以保留fork * -consistency的合法请求属性。工作区块链中的追溯叉是不太可能的，但是它们可能会发生，因为实体可以（理论上）提出一个更长的区块链，具有旧区块的不同交易历史（称为“深链重组”）。另一方面，短命的叉子相当普遍，对于使用虚拟链构建的应用程序/服务来说不是问题。节点只通过接受充分确认的交易来避免短暂的分叉。应用程序可能会增加所需的确认数量，以减少丢失或重新排序的可能性，例如，Blockstack需要10次确认（在比特币区块链中）。

为了检测深度链重组，节点运行多个过程，这些过程订阅先前块高度的几何序列。如果一个较低高度的进程得到一个不同于一个较高高度的共识哈希值，那么区块链分支可能已经发生，并且更高高度的所有进程都有可能发散的状态。这意味着所有正在运行的节点可能与引导节点位于不同的叉集中。

我们可以自动深化reorg发现，但协调fork集合需要人为干预，因为应用程序采取的不可逆转操作可能基于现在丢失的状态转换。幸运的是，长寿命的叉子非常罕见，严重到足以被广泛注意到[27] [28] [29]。这意味着当它们发生时，最终用户或应用程序开发人员可以确定哪些交易受到影响，并重新发送状态转换。

4.2交叉链迁移

通过将状态迁移到另一个区块链，虚拟链可以在潜在区块链失败的情况下幸免于难。这样做需要宣布未来的区块，直到当前区块链有效（在该区块之后的当前区块链中不会接受新的交易），然后执行两步提交以将现有状态绑定到新区块链。图6显示了从区块链A迁移到B的框架。首先，应用程序/服务管理员宣布未来的区块链，之后当前的区块链将不再用于应用程序/服务并发送特殊的“迁移”交易到当前和新的区块链（宣布迁移过程）。管理员（a）（a）获得对新区块链的锁定，（b）将当前应用程序状态（不包括历史状态转换）写入新的区块链，以及（c）释放对新区块链的锁定并打开新的区块链以处理新的交易。虚拟链验证迁移交易是由同一个主体签署的，并验证旧区块链上的最后一个已知状态与新区块链上公布的一致性散列是否一致。这可以实现无缝的跨链迁移。虚拟链作为开源[30]发布，开发人员可以使用它构建其他类型的状态机。虚拟链验证迁移交易是由同一个主体签署的，并验证旧区块链上的最后一个已知状态与新区块链上公布的一致性散列是否一致。这可以实现无缝的跨链迁移。虚拟链作为开源[30]发布，开发人员可以使用它构建其他类型的状态机。虚拟链验证迁移交易是由同一个主体签署的，并验证旧区块链上的最后一个已知状态与新区块链上公布的一致性散列是否一致。这可以实现无缝的跨链迁移。虚拟链作为开源[30]发布，开发人员可以使用它构建其他类型的状态机。

5阿特拉斯网络

区块链带宽有限，无法存储太多数据。网络上的每个节点都拥有存储在区块链上的数据副本，并且它们通常随时间线性增长，例如，2014年至2017年间，比特币区块链从14GB增长到120GB [31]。在我们的体系结构中，只有指向数据值的指针保存在区块链中; 对等网络被用作附加存储。在Blockstack实施中，对等网络存储BNS的区域文件（这些区域文件与DNS区域文件相同）。使用对等网络显着增加了存储容量，但也带来了其他挑战：传统的对等网络容易受到Sybil攻击[32]，并且不是可靠的数据源，尤其是在高速流失的情况下。

在对等网络中，参与节点同样享有特权，并协作执行某项功能或提供服务。对等网络在1999年被Napster等文件共享网络所普及[33]。对等网络中的节点保持与网络上其他对等体的子集的连接，并且这些连接可以是结构化的或非结构化的（随机连接到对等体）。在我们的架构中，我们使用对等网络进行内容发现。大型数据文件的指针存储在对等网络中，而实际数据驻留在存储后端（第6节）。

在我们的互联网架构上运行的应用程序和服务的可靠性取决于区块链层和发现/存储同行的可靠性。在不同层次中，用于发现的对等网络最容易受到可靠性问题的影响（云存储提供商拥有99.9％的正常运行时间SLA [34]，并且区块链在同级中被完全复制）。从理论上讲，任何人或公司都可以决定为其特定应用程序/服务运行（集中式）发现数据索引。应用程序还可以选择仅索引/镜像特定命名空间（TLD），并且不必为指向所有数据的指针编制索引。这有助于可扩展性。假设每个名称空间中有m个名称空间具有n个名称 - 值对。而不是索引O（m×n）记录，你可以索引O（n）记录，你的名字空间的n可能非常小。然而，实际上，全球Blockstack网络应该至少有一个（如果不是更多的话）除了任何专门的特定于应用程序的发现服务之外的所有数据的默认发现服务。此外，全球发现服务不能违反信任与信任原则，也不能集中。这意味着需要使用分散的对等网络来进行内容发现。

对等网络的挑战：对等网络在分布式系统中得到了很好的研究[35,8]，研究人员发现了与对等网络有关的几个挑战。

•可扩展性：在非结构化对等网络中，随着参与者对等体数量的增加，为查找交换的消息数量增长[35]。实用的非结构化对等网络要么使用“超级同伴”（KaZaA [36]），要么使用集中式追踪器（eDonkey 2000 [37]）。结构化的对等网络，主要基于分布式哈希表（DHT），减少了no。通常为O（logN），但遭受Sybil攻击和节点流失等问题[38]。

•性能：根据底层设计，对等网络上的读取和写入具有非常可变的延迟，但在大多数情况下，查找的最坏情况性能是不可接受的; 在处理之前，请求可能会不必要地通过多个高可用性网络链接反弹。DHT上的一些工作（如DSHT [39]和Beehive [40]）试图解决这个问题，以处理经常请求的数据，但它无助于长尾性能，仅适用于某些类型的工作负载。

•可靠性：公共对等网络允许任何人写信给他们。要处理这么多的数据，他们只需删除陈旧的数据。应用程序需要每隔一段时间重新发布一次数据以保持可用状态。数据源在重新发布之前可以脱机[41]。由于分区的缘故，结构化对等网络可能会分裂为一个或多个不相交的网络，并在稍后重新加入。这可能导致状态不一致; 一些客户可以看到关键的一个值，其他客户可以看到不同的值。

•垃圾数据写入：如果没有某种速率限制或访问控制机制，对等网络无法限制插入的数据量。对手可以用大量的垃圾数据淹没对等网络，并将节点脱机。

•节点Eclipse攻击。在结构化对等网络中，攻击者可以接管存储特定键/值对的所有节点的邻居，并有效地检查来自网络的节点/密钥。这种Sybil攻击是结构化对等网络的一个普遍问题，没有好的解决方案，不需要集中的守门人或对等连接的人工输入[42]。

对于BNS，单个区域文件的大小相当小（<4KB），并且存储这些文件所需的总空间随着数量的增加而线性增加。的域名注册。目前，在BNS上注册70,000个域名的所有区域文件只需要300MB，并且100GB的空间可以存储2.5亿个ICANN域名的区域文件（小于当前比特币区块链的大小）。受到需要存储BNS（小型）区域文件的启发，我们设计了一个名为Atlas Network的新对等网络。Atlas网络解决了使用对等网络的分散存储的特殊情况 - 其中：

1. 数据集的大小很小
2. 网络中有完整的数据索引。

所有Atlas节点都保持100％的状态副本，并且它们组织成非结构化覆盖网络。非结构化方法更容易实现，没有维护路由结构的开销，并且能抵御有针对性的节点攻击。当一个新的Atlas节点启动时，它首先获得存储在区块链中的所有数据键和值的散列值。获得索引后，Atlas节点与他们的同伴进行交谈，以获取他们没有的键/值对。Atlas网络实现了K规则随机图。每个节点使用具有延迟接受度的Metropolis-Hastings Random Walk算法（MHRWDA [43]）随机选择K个其他节点作为它的邻居，并定期询问它们是否有一组键/值对。Peers以最稀有的顺序拉动丢失的键/值对，以最大化可用性，即，写入网络的新密钥/值对优先通过网络传播。除了在本地存储密钥/值对之外，对等方还可以将其写入远程备份位置（例如Dropbox或S3等服务），以进一步防止数据丢失。当一个对端接收到一个缺失的键/值对时，它将它推送给它尚未拥有它的直接邻居。

Atlas节点已经知道区域文件的散列，因此没有人可以上传无效数据。数据复制在O（N）节点上，而不是仅在一小部分节点上（典型的基于DHT的网络）复制。Atlas网络使审查攻击代价高昂。审查整个网络需要攻击O（N）节点。相比之下，只有O（logN）DHT节点需要接管来检查每个人的键/值对。尽管如此，受害者节点将检测到审查制度，除非攻击者也将受害者比特币节点（它需要构建具有足够工作量证明的欺诈区块链叉）黯然失色。我们相信，Atlas网络向拥有可靠，难以审查和分散的同行网络迈出了重要的一步。

在我们的生产部署中，2015年9月和2016年11月，我们使用基于Kademlia的DHT网络。我们没有注意到任何明确的节点eclipse攻击，但是我们确实遇到了DHT覆盖的分区，其中一些在香港和欧洲托管的节点最终会在不同的分区上。客户流失是结构化DHT的一个普遍问题。我们的DHT节点被编程为不接受数据写入，除非数据的散列存在于区块链中，即某人已付费获得写入数据的权限。基于DHT的发现网络作为可接受的初始设计，但随着网络的不断发展，每日和每小时的流失都成为一个更大的问题。Blockstack实施在2016年秋季从基于DHT的发现网络切换到Atlas网络，自2016年11月起，

网络分区：Atlas网络比以前的DHT网络更可靠。对于我们的DHT部署，我们经常遇到网络分区问题，其中一些节点（例如在香港）将与“主线”DHT断开连接。从2015年9月到2016年9月，至少有7起重大事件需要我们与我们的社区合作，以恢复DHT部署中的网络分区。自2016年11月至本文写作之时（2017年5月），完全移至Atlas网络后，我们发生了0次网络分区事件或任何其他网络中断事件。事实上，网络上没有网络分区的概念，因为Atlas是非结构化的，所有节点都有完整的副本。

节点恢复：Atlas节点可以从故障中自行恢复。如果Atlas数据的本地索引损坏，则节点可以从区块链数据重建它。在数据丢失的情况下，节点也可以重新获取所有区域文件。我们进行了一个实验，在该实验中，我们故意销毁Atlas节点上的区域文件，并且100％的节点能够在数小时内完全恢复完整的数据丢失。Atlas网络在这方面具有自我修复功能，即使在对等网络中仍然保留极少量的数据副本，也可以从故障中恢复。

6 Gaia：分散式存储

在传统的互联网上，一旦最终用户与Facebook.com等网站建立安全连接，他们就可以登录服务并将所有数据保存在远程服务中。这种模式以及云计算的进步将所有的复杂性和用户数据推向了远程云，用户设备作为“哑屏”而存在。这完全背离了分散式互联网的精神，终端用户设备意味着处理复杂性和逻辑。

Blockstack可以让用户从这些数据孤岛中释放用户访问称为Gaia的分散存储系统的能力，从而为集中式云提供商提供可比较的性能。用户可以使用基于区块链的分散身份[44]登录应用程序和服务，并将应用程序/服务生成的数据保存到用户拥有的存储后端（而不是服务提供商）。Gaia的设计理念是以最终用户无需信任底层云提供商的方式重用现有的云提供商和基础设施。我们将云存储提供商（如Dropbox，Amazon S3和Google Drive）视为“傻瓜硬盘”并在其上存储加密和/或签名数据。像Dropbox这样的云提供商无法查看用户的数据; 他们只看到加密的数据blob。进一步，

在Gaia中，用户的区域文件包含指向数据的URI记录，并且数据构造为包含来自用户私钥的签名。写入数据涉及签署和复制数据（但不包括区域文件），读取数据涉及获取区域文件和数据，验证散列（区域文件）与区块链中的散列是否匹配，并验证数据的签名用户的公共密钥。这允许写入与签名算法和底层存储系统一样快，因为更新数据不会改变区域文件，因此不需要任何区块链交易。但是，读者和作者必须采用数据版本控制方案来避免消耗陈旧的数据。

图7显示了Gaia的概述。我们在Dropbox，Google Drive和一个FreeNAS服务器（而不是在Amazon S3上）展示了一个带有三个副本的加密数据blob示例。在我们的Blockstack实施中，我们为各个云提供商（如Dropbox和S3）提供驱动程序，并将它们作为存储后端进行集成。这隐藏了存储后端的各个API，并向Blockstack用户公开了一个简单的PUT / GET接口。查找名称的数据（如werner.id）的工作方式如下：

1. 在虚拟链中查找名称以获取（名称，散列）对。
2. 查找阿特拉斯网络中的散列（名称）以获取相应的区域文件（阿特拉斯网络中的所有对等点都具有所有区域文件的完整副本）。
3. 从区域文件获取存储后端URI并查找连接到存储后端的URI。
4. 读取数据（如果需要并且如果您有访问权限，请解密）并验证相应的签名或散列。

性能：我们架构的目标是提供与传统云提供商相媲美的性能。我们通过消除控制和故障的中心点来引入有意义的安全和容错优势，并且只要开销不显着并且对于普通用户不明显，则在读/写性能上花费小的开销就是完全值得的。我们评估了Gaia读取和写入的性能，以证明它能够以底层存储以有竞争力的速度读写文件。Gaia为每个文件增加了一个可以忽略不计的常量存储空间（压缩文件大小约为5％）。有加密和压缩的CPU开销，但由于文件大小差异非常小，因此读写的网络性能与直接访问底层存储服务的性能相似。

我们测量了将1兆字节，10兆字节和100兆字节文件上传到Amazon S3的写入性能和开销。我们发现大型（100MB）文件的CPU限制开销为2秒。许多低悬挂性能优化仍然留在我们的实施中。同样，使用S3作为存储后端从Blockstack中读取加密文件与S3的直接读取相比具有竞争力。开销的来源，验证签名和解密数据，是CPU限制的，而在实践中，性能将主要用于广域网的网络绑定。

系统可扩展性：我们架构的存储层不是可扩展性瓶颈。当代云存储系统具有高度可扩展性[34]。Atlas网络也可以很好地扩展，因为它不索引个别用户文件或文件块，而是索引指向用户存储后端的指针。存储后端处理大量的数据读取/写入操作，只有当（a）用户正在更改或更新其存储后端或公共密钥映射，或（b）新用户在系统上注册时，Atlas网络才会涉及。注册新的域/用户时，必须在底层区块链上宣布区域文件散列。底层区块链通常具有低带宽，并且是可扩展性的瓶颈（相对于Atlas网络）。我们正在探索将多个虚拟链交易打包到单个区块链交易[45]中以解决区块链可伸缩性的选项。这可以使我们能够注册数以亿计的最终用户。在实践中将数据块扩展到数十亿用户可能会发现现在并不明显的可扩展性问题，解决这些挑战是未来工作的一个领域。

7结论

我们提出Blockstack，一个由区块链保护的新的分散式互联网。Blockstack为开发人员提供了一个完整的堆栈，用于构建分散式应用程序，包括身份识别，发现和存储服务。Blockstack可以在不修改底层区块链的情况下引入新功能，并且可以承受底层区块链的故障。Blockstack的设计获得了3年来迄今为止最大的区块链生产系统的生产经验。我们的性能结果显示，Blockstack可以在传统互联网上提供与云服务相媲美的性能，并且仅引入小型CPU开销。我们已经发布了Blockstack作为开源[7]。

致谢

Blockstack由Muneeb和Ryan于2014年创立，多年来许多人为此做出了贡献。我们要感谢Larry Salibra，Guy Lepage，Patrick Stanley，Aaron Blankstein，John Light以及2500多位开源社区成员的贡献。我们将在发布白皮书的新版本时更新此列表。

参考

[1] L.纽曼，“我们对周五大规模东海岸互联网中断的了解”，2016年10月。https：//www.wired.com/2016/10/internet-outage-ddos-dns-dyn/。

[2] S. Rosenblatt，“假土耳其站点证书会造成假谷歌网站的威胁”，2013年1月。http：//cnet.co/2oArU6O。

[3] N. Perlroth，“雅虎表示，黑客在2014年偷走了5亿用户的数据，”2016年9月。http：//nyti.ms/2oAqn0G。

[4]“Blockstack网站，” 2017年[http://blockstack.org](http://blockstack.org/)。

[5]“Gotenna网状网络。” [https://www.gotenna.com](https://www.gotenna.com/)。

[6] J. Nelson，M. Ali，R. Shea和MJ Freedman，“分布式加密货币和共识分类账研讨会”（DCCL'16），（芝加哥，伊利诺斯州），2016年6月，“用虚拟链扩展现有区块链”。

[7]“Blockstack源代码释放v0.14，” 2017年<http://github.com/blockstack/blockstack-core>。

[8] R. Hasan，Z. Anwar，W. Yurcik，L. Brumbaugh和R. Campbell，“对分布式文件系统的点对点存储技术的调查”，在国际信息技术会议论文集：编码与计算（ITCC'05） - 卷02，ITCC '05，第205-213页，

[9]“Namecoin。” [https://namecoin.info](https://namecoin.info/)。

[10] V. Buterin，“下一代智能合约和分散式应用平台”，技术。rep。，9. <https://github.com/ethereum/wiki/wiki/White-Paper>。[11] M. Ali，J. Nelson，R. Shea，和MJ Freedman，“Bootstrapping trust in distributed systems with blockchains”，USENIX; login :, vol。41，没有。3，第52-58页，2016。

[12] H. Balakrishnan，S. Shenker和M. Walfish，“链接分布式系统中的无语义参考”，Peer-to-Peer Systems II，vol。计算机科学讲义“第2735页，第197-206页，Springer Berlin / Heidelberg，2003。

[13]胡安贝内，“IPFS - 内容解决，版本化，P2P文件系统”草案，ipfs.io，2015. https：//github.com/ipfs/papers。

[14] D. Mazieres，M. Kaminsky，MF Kasshoek和E. Witchel，“从文件系统安全中分离密钥管理”，Proc。（南卡罗来纳基华岛度假村）第17届SOSP，1999年。

[15] H. Kalodner，M. Carlsten，P. Ellenbogen，J. Bonneau和A. Narayanan，“Namecoin的实证研究和分散名称空间设计的经验教训”，WEIS '15：Proceedings of the 14th Workshop on the Economics信息安全，2015年6月。

[16] D. Kaminsky，“Spelunking the triangle：Exploring aaron swartzs take on zookos triangle，”Jan 10. <http://dankaminsky.com/2011/01/13/spelunk-tri/>。

[17] M. Ali，J. Nelson，R. Shea和M. Freedman，“Blockstack：A global naming and storage system secured by blockchains”，Proc。USENIX年度技术会议（ATC'16），2016年6月。

[18] J.Bonneau，A.Miller，J.Clark，A.Narayanan，JAKroll和EWFelten，“Sok：比特币和加密货币的研究视角和挑战”，2015年IEEE安全和隐私研讨会，SP2015 ，美国加利福尼亚州圣何塞市，2015年5月17 - 21日，2015年第104-121页。

[19]“让我们加密。” [https://letsencrypt.org](https://letsencrypt.org/)。

[20]“为什么Blockstack正在迁移到比特币区块链。” <https://blockstack.org/blog/> why-blockstack-is-migrating-to-the-bitcoin-blockchain。

[21] Satoshi Nakamoto，“比特币：对等电子现金系统”，技术报告，2009年。https：//bitcoin.org/bitcoin.pdf。

[22]“莱特币。” [https://litecoin.org](https://litecoin.org/)。

[23] J. Li和D. Mazi'eres，“超越拜占庭容错系统中三分之一故障复制品”，在Proc。第四届USENIX / ACM网络化系统设计与实施专题研讨会（NSDI '07），2007年2月。

[24]“比特币OP RETURN使用统计” 。2017年5月从[http://opreturn.org获取](http://opreturn.org/)。

[25] M.Jakobsson和A.Juels，“Proofs of work and bread pudding protocols，”Secure Information Networks，pp.258-272，Springer，1999。

[26]“简化名称验证协议” [。http://blockstack.org/docs/light-clients](http://blockstack.org/docs/light-clients)。

[27]“比特币改进提案50.” [https://github.com/bitcoin/bips/blob/master/bip-0050.mediawiki](https://github.com/bitcoin/bips/blob/master/) 。

[28]“比特币改善提案66” [。https](https://github.com/bitcoin/bips/blob/master/) ://github.com/bitcoin/bips/blob/master/bip-0066.mediawiki。

[29]“比特币CVE列表。” <https://en.bitcoin.it/wiki/Common_Vulnerabilities_and_Exposures>。

[30]“Virtualchain源代码释放v0.14.1，” 2017年5 <http://github.com/blockstack/> virtualchain。

[31]“比特币区块链大小。” <https://blockchain.info/charts/blocks-size>。

[32] JR Douceur，“Sybil攻击”，来自第一届国际对等系统研讨会修订后的论文，IPTPS'01（伦敦，英国），第251-260页，Springer-Verlag，2002。

[33] B.卡尔松和R.古斯塔夫松，“纳普斯特的崛起与衰落 - 进化论方法”，第347-354页。斯普林格柏林海德堡，2001年。

[34]“Google云端存储服务水平协议”。从5月份的[https://cloud.google.com/storage/sla获取](https://cloud.google.com/storage/sla)

[35] BP B，K. Bertels和S. Vassiliadis，“关于对等网络的调查”，在第16届电路，系统和信号处理研讨会（proRISC），2005年。

[36] J. Liang，R. Kumar和K. Ross，“KaZaA Overlay：A Measurement Study”，2004年9月。

[37] O. Heckmann，A. Bock，A. Mauthe和R. Steinmetz，“电子驴文件共享网络”，GI Jahrestagung（2）（P. Dadam和M. Reichert编），vol 。第51页LNI，第224-228页，GI。

[38] EK Lua，J. Crowcroft，M. Pias，R. Sharma和S. Lim，“对同层覆盖网络方案的调查和比较”，Commun。Surveys Tuts。，vol。7，第72-93页，2005年4月。

[39] MJ Freedman，E. Freudenthal和D. Mazieres，“用珊瑚民主化内容出版物”，Proc。第一个NSDI，（旧金山，加利福尼亚州），2004年。

[40] V. Ramasubramanian和EG Sirer，“Beehive：O（1）lookup performance for power-law query distributions in peer-to-peer overlays，”Proceedings of the 1st Conference on Symposium on Networked Systems Design and Implementation-Volume 1，NSDI'04，第8-8页，2004。

[41] MJ Freedman，“Coralcdn的经验：五年运营观点”，第7届USENIX网络系统设计与实施会议论文集，NSDI'10,2010。

[42] C.Lesniewski-Laas和MF Kaashoek，“WHauau：A Sybil-proof distributed hash table”，第7届USENIX网络化系统设计和实现研讨会会议（NSDI'10），（San Jose，CA ），2010年4月。

[43] C.-H. Lee，X. Xu和DY Eun在“计算机系统测量与建模联合国际会议论文集”第12届ACM SIGMETRICS / PERFORMANCE会议论文集“超越随机游走和大都会黑社会取样器：为什么不应该回溯到无偏图形采样” ，SIGMETRICS '12，第319-330页，2012年。

[44]“什么是块堆栈ID？” <https://blockstack.org/docs/blockchain-identity>。

[45]“Chainpoint白皮书”。<https://tierion.com/chainpoint>。
